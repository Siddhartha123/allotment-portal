$(function(){var e,l,a,i,t,n=[],d=[],o=s,c=s,u=$.noop,r=!0,s=!1;function p(e,l,a){return result=-1,e.some(function(e,i){if(e[l]===a)return result=i,r}),result}function f(e,l,a){$(e).append($("<div class=form-group>").append($("<label>",{for:l}).text(l)).append($("<input>",{type:"checkbox",id:l,name:l}).prop("checked",a)))}function m(){var e,l,a,i,t,o;count=(e=0,l=0,a=0,i=0,t=0,o=0,$.each(n,function(i,t){allocated=null==t.allocated?0:t.allocated.split(";").length,allocated==t.capacity?a++:allocated>t.capacity?e++:l++}),$.each(d,function(e,l){allocated=null==l.allocated?0:l.allocated.split(";").length,allocated==l.capacity?o++:allocated>l.capacity?i++:t++}),{individuals:{equal:a,exceed:e,less:l},groups:{equal:o,exceed:i,less:t}}),$("#ind_cnt_exceed").html(count.individuals.exceed),$("#ind_cnt_less").html(count.individuals.less),$("#ind_cnt_eq").html(count.individuals.equal),$("#grp_cnt_exceed").html(count.groups.exceed),$("#grp_cnt_less").html(count.groups.less),$("#grp_cnt_eq").html(count.groups.equal)}document.getElementById("file-preferences").onchange=function(){var l=this.files[0],c=new FileReader;c.onload=function(l){var c=this.result.split("\n");e=c[0].split(",");for(var u=1;u<c.length;u++)if(""!=c[u]){var h=CSV.csvToObject(c[u],{columns:e});n.push(h[0])}document.getElementById("individuals_file_input").style.display="none",document.getElementById("groups_file_input").style.display="block",document.getElementById("instructions").style.display="none",o=r,$("#jsgrid-preference").jsGrid({height:"100%",width:"100%",autoload:r,paging:s,sorting:r,filtering:r,controller:{loadData:function(e){return $.grep(n,function(l){var a=null==l.allocated?0:l.allocated.split(";").length;return!(e["Full-Name"]&&!(l["Full-Name"].indexOf(e["Full-Name"])>-1)||""+e["Unique-id"]&&!((""+l["Unique-id"]).indexOf(""+e["Unique-id"])>-1)||null!=e.allocated&&a!=e.allocated)})}},rowClick:function(e){i=e;var l=e.item;$("#namePref").html(l["Full-Name"]),$("#preference div").remove();var o=null==l.allocated?[]:l.allocated.split(";"),c=null==l.choices?[]:l.choices.split(";");$.each(o,function(e,l){-1==$.inArray(l,c)&&c.push(l)}),c!=[]&&$.each(c,function(e,l){f("#preference",l,!(-1==$.inArray(l,o)))}),a=function(){allocated=[],$("#preference input").each(function(e,a){if(a.checked)if(allocated.push(a.id),group=d.find(e=>-1!=a.id.indexOf(e["Unique-id"])),null==group)alert(a.id+"not found");else{y=null==group.allocated?[]:group.allocated.split(";"),-1==$.inArray(l["Unique-id"],y)&&y.push(l["Unique-id"]),group.allocated=y.join(";");var i=p(d,"Unique-id",group["Unique-id"]);d[i]=group}else if(group=d.find(e=>-1!=a.id.indexOf(e["Unique-id"])),null==group)alert(a.id+"not found");else if(y=null==group.allocated?[]:group.allocated.split(";"),(e=y.indexOf(l["Unique-id"]))>-1){y.splice(e,1),group.allocated=y.length>0?y.join(";"):null;i=p(d,"Unique-id",group["Unique-id"]);d[i]=group}}),l.allocated=allocated.length>0?allocated.join(";"):null;var e=p(n,"Unique-id",l["Unique-id"]);n[e]=l,$("#jsgrid-preference").jsGrid("refresh"),null!=t&&$("#jsgrid-slots").jsGrid("rowClick",t),$("#jsgrid-slots").jsGrid("refresh"),i=null,$("#detailsDialogPref").modal("hide"),m()},$("#detailsDialogPref").modal({backdrop:s,show:r}),$("#detailsDialogPref > .modal-dialog").css({top:0,left:0}),$(".modal-dialog").draggable({handle:".modal-header"})},rowRenderer:function(e){var l=e,a=$("<div>").addClass("client-info").append($("<p>").text(l["Full-Name"])),i=null==l.allocated?0:l.allocated.split(";").length,t=i>l.capacity?"exceed_cap":i==l.capacity?"full_cap":"within_cap",n=$("<div>").addClass("client-info").append($("<p>").addClass(t).text(i+" / "+l.capacity));return $("<tr>").append($("<td>").append(l["Unique-id"])).append($("<td>").append(a)).append($("<td>").append(n))},fields:[{title:"ID",name:"Unique-id",sorter:function(e,l){var a=p(n,"Unique-id",e),i=p(n,"Unique-id",l);allocated1=n[a].allocated,allocated2=n[i].allocated,capacity1=n[a].capacity,capacity2=n[i].capacity;var t=null==allocated1?0:allocated1.split(";").length,d=null==allocated2?0:allocated2.split(";").length;return t!=d?t-capacity1>d-capacity2:t>d},type:"text"},{title:"Candidates",name:"Full-Name",type:"text"},{title:"slots alloted",name:"allocated",type:"number"}]})},c.readAsText(l)},document.getElementById("file-slots").onchange=function(){var e=this.files[0],a=new FileReader;a.onload=function(e){var a=this.result.split("\n");l=a[0].split(",");for(var o=1;o<a.length;o++)if(""!=a[o]){var h=CSV.csvToObject(a[o],{columns:l});d.push(h[0])}document.getElementById("groups_file_input").style.display="none",document.getElementById("save_files").style.display="block",$(".count_stats").css("display","flex"),m(),c=r,$("#jsgrid-slots").jsGrid({height:"100%",width:"100%",autoload:r,paging:s,sorting:r,filtering:r,controller:{loadData:function(e){return $.grep(d,function(l){var a=null==l.allocated?0:l.allocated.split(";").length;return!(e["Full-Name"]&&!(l["Full-Name"].indexOf(e["Full-Name"])>-1)||""+e["Unique-id"]&&!((""+l["Unique-id"]).indexOf(""+e["Unique-id"])>-1)||null!=e.allocated&&e.allocated!=a)})}},rowClick:function(e){t=e;var l=e.item;$("#nameSlot").html(l["Full-Name"]),$("#slot div").remove();var a=null==l.allocated?[]:l.allocated.split(";"),o=null==l.choices?[]:l.choices.split(";");$.each(a,function(e,l){-1==$.inArray(l,o)&&o.push(l)}),o!=[]&&$.each(o,function(e,l){f("#slot",l,!(-1==$.inArray(l,a)))}),u=function(){allocated=[],$("#slot input").each(function(e,a){if(a.checked){allocated.push(a.id),individual=n.find(e=>e["Unique-id"]==a.id),y=null==individual.allocated?[]:individual.allocated.split(";"),-1==$.inArray(l["Unique-id"],y)&&y.push(l["Unique-id"]),individual.allocated=y.join(";");var i=p(n,"SrNum",individual.SrNum);n[i]=individual}else if(individual=n.find(e=>e["Unique-id"]==a.id),y=null==individual.allocated?[]:individual.allocated.split(";"),(e=y.indexOf(l["Unique-id"]))>-1){y.splice(e,1),individual.allocated=y.length>0?y.join(";"):null;i=p(n,"SrNum",individual.SrNum);n[i]=individual}}),l.allocated=allocated.length>0?allocated.join(";"):null;var e=p(d,"Unique-id",l["Unique-id"]);d[e]=l,$("#jsgrid-slots").jsGrid("refresh"),null!=i&&$("#jsgrid-preference").jsGrid("rowClick",i),$("#jsgrid-preference").jsGrid("refresh"),t=null,$("#detailsDialogSlot").modal("hide"),m()},$("#detailsDialogSlot").modal({backdrop:s,show:r}),$("#detailsDialogSlot > .modal-dialog").css({top:0,right:0}),$(".modal-dialog").draggable({handle:".modal-header"})},rowRenderer:function(e){var l=e,a=$("<div>").addClass("client-info").append($("<p>").text(l["Full-Name"])),i=null==l.allocated?0:l.allocated.split(";").length,t=i>l.capacity?"within_cap":i==l.capacity?"full_cap":"exceed_cap";return $("<tr>").append($("<td>").append(l["Unique-id"])).append($("<td>").append(a)).append($("<td>").append("<p>").addClass(t).text(i+" / "+l.capacity))},fields:[{title:"Course code",name:"Unique-id",sorter:function(e,l){var a=p(d,"Unique-id",e),i=p(d,"Unique-id",l);allocated1=d[a].allocated,allocated2=d[i].allocated,capacity1=d[a].capacity,capacity2=d[i].capacity;var t=null==allocated1?0:allocated1.split(";").length,n=null==allocated2?0:allocated2.split(";").length;return t!=n?t-capacity1>n-capacity2:t>n},type:"text"},{title:"Course name",name:"Full-Name",type:"text"},{title:"Requirement",name:"allocated",type:"number"}]})},a.readAsText(e)},$("#custom_check_pref").change(function(){$(this).is(":checked")&&""!=$("#custom_input_pref").val()&&(f("#preference",$("#custom_input_pref").val(),r),$(this).prop("checked",s),$("#custom_input_pref").val(""))}),$("#custom_check_slot").change(function(){$(this).is(":checked")&&""!=$("#custom_input_slot").val()&&(f("#slot",$("#custom_input_slot").val(),r),$(this).prop("checked",s),$("#custom_input_slot").val(""))}),$("#detailsFormPref").validate({submitHandler:function(){a()}}),$("#detailsFormSlot").validate({submitHandler:function(){u()}}),$("#saveFiles").click(function(){if(o&&c){var a,i=CSV.objectToCsv(n,{columns:e}),t=new Blob([i],{type:"text/csv"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(t,"individuals.csv");else(a=window.document.createElement("a")).href=window.URL.createObjectURL(t),a.download="individuals.csv",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(a.href),document.body.removeChild(a);if(i=CSV.objectToCsv(d,{columns:l}),t=new Blob([i],{type:"text/csv"}),window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(t,"groups.csv");else(a=window.document.createElement("a")).href=window.URL.createObjectURL(t),a.download="groups.csv",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(a.href),document.body.removeChild(a)}else alert("Load both files first !")})});